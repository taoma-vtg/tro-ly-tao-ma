<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ Lý AI Tạo Mã (V24 - Giám sát)</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f6f9; color: #333; margin: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        h1, h2 { text-align: center; color: #1a253c; }
        .step { margin-top: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .button { display: block; width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; text-align: center; font-weight: bold; margin-top: 15px; }
        .btn-upload { background-color: #17a2b8; }
        .btn-ai { background-color: #6f42c1; }
        .btn-generate { background-color: #28a745; margin-top: 20px;}
        #status { text-align: center; font-weight: bold; margin: 15px 0; min-height: 20px; color: #007bff; }
        #image-preview-container { text-align: center; margin-top: 15px; }
        #image-preview { max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="text"] { width: 95%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 15px; }
        .final-code { background-color: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 15px; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <h1>Trợ Lý AI Tạo Mã Vật Tư (V24)</h1>

    <div class="step">
        <h2>Bước 1: Cung Cấp Thông Tin</h2>
        <input type="file" id="uploader" accept="image/*" style="display:none;">
        <label for="uploader" class="button btn-upload">Chọn Ảnh từ Album hoặc Chụp Ảnh Mới</label>
        <div id="image-preview-container" style="display:none;">
            <img id="image-preview" src="" alt="Ảnh đã chọn">
        </div>
        <div id="status"></div>
    </div>

    <div class="step">
        <h2>Bước 2: Kết Quả AI Gợi Ý (Có thể sửa)</h2>
        <input type="password" id="google-api-key" placeholder="Dán Google AI API Key vào đây (sẽ tự lưu)" style="width: 98%; padding: 10px; margin-bottom: 15px;">
        <div class="grid-container">
            <div>
                <h4>Tiếng Việt</h4>
                <div class="form-group"><label for="name_vi">Tên vật tư:</label><input type="text" id="name_vi"></div>
                <div class="form-group"><label for="model_vi">Model:</label><input type="text" id="model_vi"></div>
                <div class="form-group"><label for="maker_vi">Nhà sản xuất:</label><input type="text" id="maker_vi"></div>
                <div class="form-group"><label for="desc_vi">Mô tả:</label><input type="text" id="desc_vi"></div>
            </div>
            <div>
                <h4>English</h4>
                <div class="form-group"><label for="name_en">Materials name:</label><input type="text" id="name_en"></div>
                <div class="form-group"><label for="model_en">Model:</label><input type="text" id="model_en"></div>
                <div class="form-group"><label for="maker_en">Maker:</label><input type="text" id="maker_en"></div>
                <div class="form-group"><label for="desc_en">Description:</label><input type="text" id="desc_en"></div>
            </div>
        </div>
    </div>
    
    <div class="step">
        <h2>Bước 3: Tạo Mã Cuối Cùng</h2>
        <button class="button btn-generate" onclick="generateFinalCode()">Tạo Mã từ thông tin đã sửa</button>
        <div id="final-result-container"></div>
    </div>
</div>

<script>
    const uploader = document.getElementById('uploader');
    const statusDiv = document.getElementById('status');
    const apiKeyInput = document.getElementById('google-api-key');
    const imagePreview = document.getElementById('image-preview');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const finalResultContainer = document.getElementById('final-result-container');

    const ocrApiKey = 'K87379629688957'; 

    window.addEventListener('load', () => {
        const savedKey = localStorage.getItem('googleApiKey_v24');
        if (savedKey) { apiKeyInput.value = savedKey; }
    });

    uploader.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // Hiển thị ảnh preview
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreviewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);

        statusDiv.innerText = 'Đang đọc chữ từ ảnh (OCR)...';
        finalResultContainer.innerHTML = ''; // Xóa kết quả cũ
        
        // Gọi OCR và AI
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('apikey', ocrApiKey);
            formData.append('language', 'eng');

            const ocrResponse = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
            const ocrData = await ocrResponse.json();
            if (ocrData.IsErroredOnProcessing || !ocrData.ParsedResults?.length) {
                throw new Error(ocrData.ErrorMessage?.[0] || 'OCR không nhận dạng được chữ.');
            }
            const rawText = ocrData.ParsedResults[0].ParsedText;
            
            statusDiv.innerText = 'OCR thành công. Đang nhờ AI bóc tách...';
            await callAI(rawText);

        } catch (error) {
            statusDiv.innerText = `Lỗi: ${error.message}`;
        }
    });

    async function callAI(rawText) {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            alert('Vui lòng nhập Google AI API Key!');
            statusDiv.innerText = 'Lỗi: Thiếu API Key.';
            return;
        }
        localStorage.setItem('googleApiKey_v24', apiKey);

        const prompt = `
            You are a precise data extraction bot. Your ONLY job is to populate a JSON object based on the rules below.
            Input Text:
            ---
            ${rawText}
            ---
            Your Task:
            1. Analyze the Input Text.
            2. Create a JSON object with the keys: "name_vi", "model", "maker", "desc_vi", "name_en", "desc_en".
            3. Follow these rules with ZERO exceptions:
                - "model": Find the single most specific model number or Part Number (P/N).
                - "name_vi": Describe the general product type in Vietnamese. It MUST NOT contain the model number or maker. Correct example: "Tivi 43 inch". INCORRECT example: "Tivi LG 43LF510T".
                - "maker": Identify the manufacturer.
                - "desc_vi": List ALL other technical specs. It MUST NOT contain the model number or maker. If the text is sparse, use your knowledge to find more specs for the model.
                - Translate "name_vi" and "desc_vi" for "name_en" and "desc_en".
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Lỗi từ AI API: ${errorData.error.message}`);
            }
            const data = await response.json();
            const aiResponseText = data.candidates[0].content.parts[0].text;
            const jsonString = aiResponseText.replace(/```json/g, '').replace(/```/g, '').trim();
            const parsedData = JSON.parse(jsonString);
            
            // Điền kết quả vào các ô input
            document.getElementById('name_vi').value = parsedData.name_vi || '';
            document.getElementById('model_vi').value = parsedData.model || '';
            document.getElementById('maker_vi').value = parsedData.maker || '';
            document.getElementById('desc_vi').value = parsedData.desc_vi || '';
            document.getElementById('name_en').value = parsedData.name_en || '';
            document.getElementById('model_en').value = parsedData.model || '';
            document.getElementById('maker_en').value = parsedData.maker || '';
            document.getElementById('desc_en').value = parsedData.desc_en || '';
            
            statusDiv.innerText = 'AI đã gợi ý xong! Vui lòng kiểm tra và sửa lại nếu cần, sau đó nhấn nút "Tạo Mã".';

        } catch (error) {
            statusDiv.innerText = `Lỗi AI: ${error.message}`;
        }
    }
    
    function generateFinalCode() {
        // Lấy dữ liệu đã được người dùng sửa
        const getValues = (lang) => ({
            name: document.getElementById(`name_${lang}`).value.trim(),
            model: document.getElementById(`model_${lang}`).value.trim(),
            maker: document.getElementById(`maker_${lang}`).value.trim(),
            desc: document.getElementById(`desc_${lang}`).value.trim(),
        });

        const vi = getValues('vi');
        const en = getValues('en');

        if (!vi.name || !vi.model || !vi.maker || !vi.desc) {
            alert('Vui lòng điền đầy đủ các trường thông tin!');
            return;
        }
        // Tự động điền các trường tiếng Anh nếu trống
        if(!en.name && vi.name) document.getElementById('name_en').value = 'N/A';
        if(!en.desc && vi.desc) document.getElementById('desc_en').value = 'N/A';
        en.name = document.getElementById('name_en').value.trim();
        en.desc = document.getElementById('desc_en').value.trim();
        en.model = vi.model; document.getElementById('model_en').value = vi.model;
        en.maker = vi.maker; document.getElementById('maker_en').value = vi.maker;

        const code_vi = `${vi.name}_${vi.model}_${vi.maker}_${vi.desc}`;
        const code_en = `${en.name}_${en.model}_${en.maker}_${en.desc}`;

        finalResultContainer.innerHTML = `
            <div class="final-code">
                <p><b>Mã Tiếng Việt:</b><br><code>${code_vi}</code></p>
            </div>
            <div class="final-code">
                <p><b>English Code:</b><br><code>${code_en}</code></p>
            </div>
        `;
    }
</script>
</body>
</html>